/**
 * Copyright (C) 2010-2015 Graham Breach
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */
/**
 * jQuery.tagcanvas 2.7
 * For more information, please contact <graham@goat1000.com>
 */
(function(ao){var M,K,L=Math.abs,ag=Math.sin,w=Math.cos,s=Math.max,aC=Math.min,ap=Math.ceil,F=Math.sqrt,ar=Math.pow,h={},l={},m={0:"0,",1:"17,",2:"34,",3:"51,",4:"68,",5:"85,",6:"102,",7:"119,",8:"136,",9:"153,",a:"170,",A:"170,",b:"187,",B:"187,",c:"204,",C:"204,",d:"221,",D:"221,",e:"238,",E:"238,",f:"255,",F:"255,"},x,c,Q,aE,H,aF,aa,C=document,p,b={};for(M=0;M<256;++M){K=M.toString(16);if(M<16){K="0"+K}l[K]=l[K.toUpperCase()]=M.toString()+","}function ah(i){return typeof i!="undefined"}function I(i){return typeof i=="object"&&i!=null}function au(i,j,aG){return isNaN(i)?aG:aC(aG,s(j,i))}function az(){return false}function G(){return new Date().valueOf()}function A(aG,aJ){var j=[],aH=aG.length,aI;for(aI=0;aI<aH;++aI){j.push(aG[aI])}j.sort(aJ);return j}function am(j){var aH=j.length-1,aG,aI;while(aH){aI=~~(Math.random()*aH);aG=j[aH];j[aH]=j[aI];j[aI]=aG;--aH}}function ad(i,aG,j){this.x=i;this.y=aG;this.z=j}H=ad.prototype;H.length=function(){return F(this.x*this.x+this.y*this.y+this.z*this.z)};H.dot=function(i){return this.x*i.x+this.y*i.y+this.z*i.z};H.cross=function(j){var i=this.y*j.z-this.z*j.y,aH=this.z*j.x-this.x*j.z,aG=this.x*j.y-this.y*j.x;return new ad(i,aH,aG)};H.angle=function(j){var i=this.dot(j),aG;if(i==0){return Math.PI/2}aG=i/(this.length()*j.length());if(aG>=1){return 0}if(aG<=-1){return Math.PI}return Math.acos(aG)};H.unit=function(){var i=this.length();return new ad(this.x/i,this.y/i,this.z/i)};function ai(aG,j){j=j*Math.PI/180;aG=aG*Math.PI/180;var i=ag(aG)*w(j),aI=-ag(j),aH=-w(aG)*w(j);return new ad(i,aI,aH)}function R(i){this[1]={1:i[0],2:i[1],3:i[2]};this[2]={1:i[3],2:i[4],3:i[5]};this[3]={1:i[6],2:i[7],3:i[8]}}aE=R.prototype;R.Identity=function(){return new R([1,0,0,0,1,0,0,0,1])};R.Rotation=function(aH,i){var j=ag(aH),aG=w(aH),aI=1-aG;return new R([aG+ar(i.x,2)*aI,i.x*i.y*aI-i.z*j,i.x*i.z*aI+i.y*j,i.y*i.x*aI+i.z*j,aG+ar(i.y,2)*aI,i.y*i.z*aI-i.x*j,i.z*i.x*aI-i.y*j,i.z*i.y*aI+i.x*j,aG+ar(i.z,2)*aI])};aE.mul=function(aG){var aH=[],aK,aJ,aI=(aG.xform?1:0);for(aK=1;aK<=3;++aK){for(aJ=1;aJ<=3;++aJ){if(aI){aH.push(this[aK][1]*aG[1][aJ]+this[aK][2]*aG[2][aJ]+this[aK][3]*aG[3][aJ])}else{aH.push(this[aK][aJ]*aG)}}}return new R(aH)};aE.xform=function(aG){var j={},i=aG.x,aI=aG.y,aH=aG.z;j.x=i*this[1][1]+aI*this[2][1]+aH*this[3][1];j.y=i*this[1][2]+aI*this[2][2]+aH*this[3][2];j.z=i*this[1][3]+aI*this[2][3]+aH*this[3][3];return j};function q(aH,aJ,aO,aL){var aK,aN,j,aM,aP=[],aI=Math.PI*(3-F(5)),aG=2/aH;for(aK=0;aK<aH;++aK){aN=aK*aG-1+(aG/2);j=F(1-aN*aN);aM=aK*aI;aP.push([w(aM)*j*aJ,aN*aO,ag(aM)*j*aL])}return aP}function W(aI,aG,aL,aR,aP){var aQ,aS=[],aJ=Math.PI*(3-F(5)),aH=2/aI,aO,aN,aM,aK;for(aO=0;aO<aI;++aO){aN=aO*aH-1+(aH/2);aQ=aO*aJ;aM=w(aQ);aK=ag(aQ);aS.push(aG?[aN*aL,aM*aR,aK*aP]:[aM*aL,aN*aR,aK*aP])}return aS}function N(aG,aH,aK,aQ,aO,aM){var aP,aR=[],aI=Math.PI*2/aH,aN,aL,aJ;for(aN=0;aN<aH;++aN){aP=aN*aI;aL=w(aP);aJ=ag(aP);aR.push(aG?[aM*aK,aL*aQ,aJ*aO]:[aL*aK,aM*aQ,aJ*aO])}return aR}function al(aH,i,j,aG){return W(aH,0,i,j,aG)}function at(aH,i,j,aG){return W(aH,1,i,j,aG)}function d(aI,i,j,aG,aH){aH=isNaN(aH)?0:aH*1;return N(0,aI,i,j,aG,aH)}function n(aI,i,j,aG,aH){aH=isNaN(aH)?0:aH*1;return N(1,aI,i,j,aG,aH)}function an(aG){var j=new Image;j.onload=function(){var aH=j.width/2,i=j.height/2;aG.centreFunc=function(aM,aJ,aK,aI,aL){aM.setTransform(1,0,0,1,0,0);aM.globalAlpha=1;aM.drawImage(j,aI-aH,aL-i)}};j.src=aG.centreImage}function U(aJ,i){var aI=aJ,aH,aG,j=(i*1).toPrecision(3)+")";if(aJ[0]==="#"){if(!h[aJ]){if(aJ.length===4){h[aJ]="rgba("+m[aJ[1]]+m[aJ[2]]+m[aJ[3]]}else{h[aJ]="rgba("+l[aJ.substr(1,2)]+l[aJ.substr(3,2)]+l[aJ.substr(5,2)]}}aI=h[aJ]+j}else{if(aJ.substr(0,4)==="rgb("||aJ.substr(0,4)==="hsl("){aI=(aJ.replace("(","a(").replace(")",","+j))}else{if(aJ.substr(0,5)==="rgba("||aJ.substr(0,5)==="hsla("){aH=aJ.lastIndexOf(",")+1,aG=aJ.indexOf(")");i*=parseFloat(aJ.substring(aH,aG));aI=aJ.substr(0,aH)+i.toPrecision(3)+")"}}}return aI}function P(i,j){if(window.G_vmlCanvasManager){return null}var aG=C.createElement("canvas");aG.width=i;aG.height=j;return aG}function ak(){var j=P(3,3),aH,aG;if(!j){return false}aH=j.getContext("2d");aH.strokeStyle="#000";aH.shadowColor="#fff";aH.shadowBlur=3;aH.globalAlpha=0;aH.strokeRect(2,2,2,2);aH.globalAlpha=1;aG=aH.getImageData(2,2,1,1);j=null;return(aG.data[0]>0)}function aj(aK,j,aJ,aI){var aH=aK.createLinearGradient(0,0,j,0),aG;for(aG in aI){aH.addColorStop(1-aG,aI[aG])}aK.fillStyle=aH;aK.fillRect(0,aJ,j,1)}function k(aI,aG,j){var aH=1024,aM=1,aL=aI.weightGradient,aK,aO,aJ,aN;if(aI.gCanvas){aO=aI.gCanvas.getContext("2d");aM=aI.gCanvas.height}else{if(I(aL[0])){aM=aL.length}else{aL=[aL]}aI.gCanvas=aK=P(aH,aM);if(!aK){return null}aO=aK.getContext("2d");for(aJ=0;aJ<aM;++aJ){aj(aO,aH,aJ,aL[aJ])}}j=s(aC(j||0,aM-1),0);aN=aO.getImageData(~~((aH-1)*aG),j,1,1).data;return"rgba("+aN[0]+","+aN[1]+","+aN[2]+","+(aN[3]/255)+")"}function X(aP,aI,j,aT,aS,aQ,aO,aK,aH,aR,aJ,aN){var aM=aS+(aK||0)+(aH.length&&aH[0]<0?L(aH[0]):0),aG=aQ+(aK||0)+(aH.length&&aH[1]<0?L(aH[1]):0),aL,aU;aP.font=aI;aP.textBaseline="top";aP.fillStyle=j;aO&&(aP.shadowColor=aO);aK&&(aP.shadowBlur=aK);aH.length&&(aP.shadowOffsetX=aH[0],aP.shadowOffsetY=aH[1]);for(aL=0;aL<aT.length;++aL){aU=0;if(aJ){if("right"==aN){aU=aR-aJ[aL]}else{if("centre"==aN){aU=(aR-aJ[aL])/2}}}aP.fillText(aT[aL],aM+aU,aG);aG+=parseInt(aI)}}function aq(aK,i,aJ,j,aH,aI,aG){if(aI){aK.beginPath();aK.moveTo(i,aJ+aH-aI);aK.arcTo(i,aJ,i+aI,aJ,aI);aK.arcTo(i+j,aJ,i+j,aJ+aI,aI);aK.arcTo(i+j,aJ+aH,i+j-aI,aJ+aH,aI);aK.arcTo(i,aJ+aH,i,aJ+aH-aI,aI);aK.closePath();aK[aG?"stroke":"fill"]()}else{aK[aG?"strokeRect":"fillRect"](i,aJ,j,aH)}}function g(aM,i,aK,aH,aL,aG,aI,aJ,j){this.strings=aM;this.font=i;this.width=aK;this.height=aH;this.maxWidth=aL;this.stringWidths=aG;this.align=aI;this.valign=aJ;this.scale=j}aa=g.prototype;aa.SetImage=function(aJ,j,aH,i,aI,aL,aG,aK){this.image=aJ;this.iwidth=j*this.scale;this.iheight=aH*this.scale;this.ipos=i;this.ipad=aI*this.scale;this.iscale=aK;this.ialign=aL;this.ivalign=aG};aa.Align=function(j,aG,i){var aH=0;if(i=="right"||i=="bottom"){aH=aG-j}else{if(i!="left"&&i!="top"){aH=(aG-j)/2}}return aH};aa.Create=function(aS,aY,aR,aZ,aX,aW,i,aV,aO){var aM,aK,aT,a4,a1,a0,aI,aH,aG,j,aL,aJ,aN,aU,a3=L(i[0]),a2=L(i[1]),aP,aQ;aV=s(aV,a3+aW,a2+aW);a1=2*(aV+aZ);aI=2*(aV+aZ);aK=this.width+a1;aT=this.height+aI;aG=j=aV+aZ;if(this.image){aL=aJ=aV+aZ;aN=this.iwidth;aU=this.iheight;if(this.ipos=="top"||this.ipos=="bottom"){if(aN<this.width){aL+=this.Align(aN,this.width,this.ialign)}else{aG+=this.Align(this.width,aN,this.align)}if(this.ipos=="top"){j+=aU+this.ipad}else{aJ+=this.height+this.ipad}aK=s(aK,aN+a1);aT+=aU+this.ipad}else{if(aU<this.height){aJ+=this.Align(aU,this.height,this.ivalign)}else{j+=this.Align(this.height,aU,this.valign)}if(this.ipos=="right"){aL+=this.width+this.ipad}else{aG+=aN+this.ipad}aK+=aN+this.ipad;aT=s(aT,aU+aI)}}aM=P(aK,aT);if(!aM){return null}a1=aI=aZ/2;a0=aK-aZ;aH=aT-aZ;a4=aM.getContext("2d");if(aY){a4.fillStyle=aY;aq(a4,a1,aI,a0,aH,aO)}if(aZ){a4.strokeStyle=aR;a4.lineWidth=aZ;aq(a4,a1,aI,a0,aH,aO,true)}if(aW||a3||a2){aP=P(aK,aT);if(aP){aQ=a4;a4=aP.getContext("2d")}}X(a4,this.font,aS,this.strings,aG,j,0,0,[],this.maxWidth,this.stringWidths,this.align);if(this.image){a4.drawImage(this.image,aL,aJ,aN,aU)}if(aQ){a4=aQ;aX&&(a4.shadowColor=aX);aW&&(a4.shadowBlur=aW);a4.shadowOffsetX=i[0];a4.shadowOffsetY=i[1];a4.drawImage(aP,0,0)}return aM};function v(aH,j,aI){var aG=P(j,aI),aJ;if(!aG){return null}aJ=aG.getContext("2d");aJ.drawImage(aH,(j-aH.width)/2,(aI-aH.height)/2);return aG}function aw(aH,j,aI){var aG=P(j,aI),aJ;if(!aG){return null}aJ=aG.getContext("2d");aJ.drawImage(aH,0,0,j,aI);return aG}function aB(aS,aN,aT,aX,aO,aM,aL,aQ,aJ,aK){var aH=aN+((2*aQ)+aM)*aX,aP=aT+((2*aQ)+aM)*aX,aI=P(aH,aP),aW,aV,aG,aU,j,aY,aR;if(!aI){return null}aM*=aX;aJ*=aX;aV=aG=aM/2;aU=aH-aM;j=aP-aM;aQ=(aQ*aX)+aV;aW=aI.getContext("2d");if(aO){aW.fillStyle=aO;aq(aW,aV,aG,aU,j,aJ)}if(aM){aW.strokeStyle=aL;aW.lineWidth=aM;aq(aW,aV,aG,aU,j,aJ,true)}if(aK){aY=P(aH,aP);aR=aY.getContext("2d");aR.drawImage(aS,aQ,aQ,aN,aT);aR.globalCompositeOperation="source-in";aR.fillStyle=aL;aR.fillRect(0,0,aH,aP);aR.globalCompositeOperation="destination-over";aR.drawImage(aI,0,0);aR.globalCompositeOperation="source-over";aW.drawImage(aY,0,0)}else{aW.drawImage(aS,aQ,aQ,aS.width,aS.height)}return{image:aI,width:aH/aX,height:aP/aX}}function Z(aM,aS,aO,aI,aQ,aR,aH){var aT=L(aH[0]),aN=L(aH[1]),aJ=aS+(aT>aR?aT+aR:aR*2)*aI,j=aO+(aN>aR?aN+aR:aR*2)*aI,aL=aI*((aR||0)+(aH[0]<0?aT:0)),aG=aI*((aR||0)+(aH[1]<0?aN:0)),aK,aP;aK=P(aJ,j);if(!aK){return null}aP=aK.getContext("2d");aQ&&(aP.shadowColor=aQ);aR&&(aP.shadowBlur=aR*aI);aH&&(aP.shadowOffsetX=aH[0]*aI,aP.shadowOffsetY=aH[1]*aI);aP.drawImage(aM,aL,aG,aS,aO);return{image:aK,width:aJ/aI,height:j/aI}}function t(aS,aK,aQ){var aR=parseInt(aS.toString().length*aQ),aJ=parseInt(aQ*2*aS.length),aH=P(aR,aJ),aN,j,aI,aM,aP,aO,aG,aL;if(!aH){return null}aN=aH.getContext("2d");aN.fillStyle="#000";aN.fillRect(0,0,aR,aJ);X(aN,aQ+"px "+aK,"#fff",aS,0,0,0,0,[],"centre");j=aN.getImageData(0,0,aR,aJ);aI=j.width;aM=j.height;aL={min:{x:aI,y:aM},max:{x:-1,y:-1}};for(aO=0;aO<aM;++aO){for(aP=0;aP<aI;++aP){aG=(aO*aI+aP)*4;if(j.data[aG+1]>0){if(aP<aL.min.x){aL.min.x=aP}if(aP>aL.max.x){aL.max.x=aP}if(aO<aL.min.y){aL.min.y=aO}if(aO>aL.max.y){aL.max.y=aO}}}}if(aI!=aR){aL.min.x*=(aR/aI);aL.max.x*=(aR/aI)}if(aM!=aJ){aL.min.y*=(aR/aM);aL.max.y*=(aR/aM)}aH=null;return aL}function o(i){return"'"+i.replace(/(\'|\")/g,"").replace(/\s*,\s*/g,"', '")+"'"}function ac(i,j,aG){aG=aG||C;if(aG.addEventListener){aG.addEventListener(i,j,false)}else{aG.attachEvent("on"+i,j)}}function a(i,j,aG){aG=aG||C;if(aG.removeEventListener){aG.removeEventListener(i,j)}else{aG.detachEvent("on"+i,j)}}function av(aK,aG,aO,aJ){var aP=aJ.imageScale,aM,aH,aL,j,aI,aN;if(!aG.complete){return ac("load",function(){av(aK,aG,aO,aJ)},aG)}if(!aK.complete){return ac("load",function(){av(aK,aG,aO,aJ)},aK)}aG.width=aG.width;aG.height=aG.height;if(aP){aK.width=aG.width*aP;aK.height=aG.height*aP}aO.iw=aK.width;aO.ih=aK.height;if(aJ.txtOpt){aH=aK;aM=aJ.zoomMax*aJ.txtScale;aI=aO.iw*aM;aN=aO.ih*aM;if(aI<aG.naturalWidth||aN<aG.naturalHeight){aH=aw(aK,aI,aN);if(aH){aO.fimage=aH}}else{aI=aO.iw;aN=aO.ih;aM=1}if(!aO.HasText()){if(aJ.shadow){aH=Z(aO.image,aI,aN,aM,aJ.shadow,aJ.shadowBlur,aJ.shadowOffset);if(aH){aO.fimage=aH.image;aO.w=aH.width;aO.h=aH.height}}if(aJ.bgColour||aJ.bgOutlineThickness){aL=aJ.bgColour=="tag"?Y(aO.a,"background-color"):aJ.bgColour;j=aJ.bgOutline=="tag"?Y(aO.a,"color"):(aJ.bgOutline||aJ.textColour);aI=aO.fimage.width;aN=aO.fimage.height;if(aJ.outlineMethod=="colour"){aH=aB(aO.fimage,aI,aN,aM,aL,aJ.bgOutlineThickness,aJ.outlineColour,aJ.padding,aJ.bgRadius,1);if(aH){aO.oimage=aH.image}}aH=aB(aO.fimage,aI,aN,aM,aL,aJ.bgOutlineThickness,j,aJ.padding,aJ.bgRadius);if(aH){aO.fimage=aH.image;aO.w=aH.width;aO.h=aH.height}}if(aJ.outlineMethod=="size"){if(aJ.outlineIncrease>0){aO.iw+=2*aJ.outlineIncrease;aO.ih+=2*aJ.outlineIncrease;aI=aM*aO.iw;aN=aM*aO.ih;aH=aw(aO.fimage,aI,aN);aO.oimage=aH;aO.fimage=v(aO.fimage,aO.oimage.width,aO.oimage.height)}else{aI=aM*(aO.iw+(2*aJ.outlineIncrease));aN=aM*(aO.ih+(2*aJ.outlineIncrease));aH=aw(aO.fimage,aI,aN);aO.oimage=v(aH,aO.fimage.width,aO.fimage.height)}}}}aO.Init()}function Y(aH,aG){var j=C.defaultView,i=aG.replace(/\-([a-z])/g,function(aI){return aI.charAt(1).toUpperCase()});return(j&&j.getComputedStyle&&j.getComputedStyle(aH,null).getPropertyValue(aG))||(aH.currentStyle&&aH.currentStyle[i])}function u(j,aH,aG){var i=1,aI;if(aH){i=1*(j.getAttribute(aH)||aG)}else{if(aI=Y(j,"font-size")){i=(aI.indexOf("px")>-1&&aI.replace("px","")*1)||(aI.indexOf("pt")>-1&&aI.replace("pt","")*1.25)||aI*3.3}}return i}function f(i){return i.target&&ah(i.target.id)?i.target.id:i.srcElement.parentNode.id}function S(aI,aJ){var aH,aG,i=parseInt(Y(aJ,"width"))/aJ.width,j=parseInt(Y(aJ,"height"))/aJ.height;if(ah(aI.offsetX)){aH={x:aI.offsetX,y:aI.offsetY}}else{aG=ab(aJ.id);if(ah(aI.changedTouches)){aI=aI.changedTouches[0]}if(aI.pageX){aH={x:aI.pageX-aG.x,y:aI.pageY-aG.y}}}if(aH&&i&&j){aH.x/=i;aH.y/=j}return aH}function B(aG){var j=aG.target||aG.fromElement.parentNode,i=y.tc[j.id];if(i){i.mx=i.my=-1;i.UnFreeze();i.EndDrag()}}function ae(aK){var aH,aG=y,j,aJ,aI=f(aK);for(aH in aG.tc){j=aG.tc[aH];if(j.tttimer){clearTimeout(j.tttimer);j.tttimer=null}}if(aI&&aG.tc[aI]){j=aG.tc[aI];if(aJ=S(aK,j.canvas)){j.mx=aJ.x;j.my=aJ.y;j.Drag(aK,aJ)}j.drawn=0}}function z(aH){var j=y,i=C.addEventListener?0:1,aG=f(aH);if(aG&&aH.button==i&&j.tc[aG]){j.tc[aG].BeginDrag(aH)}}function aD(aI){var aG=y,j=C.addEventListener?0:1,aH=f(aI),i;if(aH&&aI.button==j&&aG.tc[aH]){i=aG.tc[aH];ae(aI);if(!i.EndDrag()&&!i.touchState){i.Clicked(aI)}}}function T(aH){var j=f(aH),i=(j&&y.tc[j]),aG;if(i&&aH.changedTouches){if(aH.touches.length==1&&i.touchState==0){i.touchState=1;i.BeginDrag(aH);if(aG=S(aH,i.canvas)){i.mx=aG.x;i.my=aG.y;i.drawn=0}}else{if(aH.targetTouches.length==2&&i.pinchZoom){i.touchState=3;i.EndDrag();i.BeginPinch(aH)}else{i.EndDrag();i.EndPinch();i.touchState=0}}}}function r(aG){var j=f(aG),i=(j&&y.tc[j]);if(i&&aG.changedTouches){switch(i.touchState){case 1:i.Draw();i.Clicked();break;case 2:i.EndDrag();break;case 3:i.EndPinch()}i.touchState=0}}function ay(aK){var aH,aG=y,j,aJ,aI=f(aK);for(aH in aG.tc){j=aG.tc[aH];if(j.tttimer){clearTimeout(j.tttimer);j.tttimer=null}}j=(aI&&aG.tc[aI]);if(j&&aK.changedTouches&&j.touchState){switch(j.touchState){case 1:case 2:if(aJ=S(aK,j.canvas)){j.mx=aJ.x;j.my=aJ.y;if(j.Drag(aK,aJ)){j.touchState=2}}break;case 3:j.Pinch(aK)}j.drawn=0}}function af(aG){var i=y,j=f(aG);if(j&&i.tc[j]){aG.cancelBubble=true;aG.returnValue=false;aG.preventDefault&&aG.preventDefault();i.tc[j].Wheel((aG.wheelDelta||aG.detail)>0)}}function O(){E(G())}function E(aH){var j=y.tc,aG;y.NextFrame(y.interval);aH=aH||G();for(aG in j){j[aG].Draw(aH)}}function ab(aG){var aJ=C.getElementById(aG),i=aJ.getBoundingClientRect(),aM=C.documentElement,aK=C.body,aL=window,aH=aL.pageXOffset||aM.scrollLeft,aN=aL.pageYOffset||aM.scrollTop,aI=aM.clientLeft||aK.clientLeft,j=aM.clientTop||aK.clientTop;return{x:i.left+aH-aI,y:i.top+aN-j}}function V(j,aH,aI,aG){var i=j.radius*j.z1/(j.z1+j.z2+aH.z);return{x:aH.x*i*aI,y:aH.y*i*aG,z:aH.z,w:(j.z1-aH.z)/j.z2}}function aA(i){this.e=i;this.br=0;this.line=[];this.text=[];this.original=i.innerText||i.textContent}aF=aA.prototype;aF.Empty=function(){for(var j=0;j<this.text.length;++j){if(this.text[j].length){return false}}return true};aF.Lines=function(aI){var aH=aI?1:0,aJ,j,aG;aI=aI||this.e;aJ=aI.childNodes;j=aJ.length;for(aG=0;aG<j;++aG){if(aJ[aG].nodeName=="BR"){this.text.push(this.line.join(" "));this.br=1}else{if(aJ[aG].nodeType==3){if(this.br){this.line=[aJ[aG].nodeValue];this.br=0}else{this.line.push(aJ[aG].nodeValue)}}else{this.Lines(aJ[aG])}}}aH||this.br||this.text.push(this.line.join(" "));return this.text};aF.SplitWidth=function(aG,aN,aK,aJ){var aI,aH,aM,aL=[];aN.font=aJ+"px "+aK;for(aI=0;aI<this.text.length;++aI){aM=this.text[aI].split(/\s+/);this.line=[aM[0]];for(aH=1;aH<aM.length;++aH){if(aN.measureText(this.line.join(" ")+" "+aM[aH]).width>aG){aL.push(this.line.join(" "));this.line=[aM[aH]]}else{this.line.push(aM[aH])}}aL.push(this.line.join(" "))}return this.text=aL};function J(i,j){this.ts=G();this.tc=i;this.tag=j;this.x=this.y=this.w=this.h=this.sc=1;this.z=0;this.Draw=i.pulsateTo<1&&i.outlineMethod!="colour"?this.DrawPulsate:this.DrawSimple;this.radius=i.outlineRadius|0;this.SetMethod(i.outlineMethod)}x=J.prototype;x.SetMethod=function(aG){var j={block:["PreDraw","DrawBlock"],colour:["PreDraw","DrawColour"],outline:["PostDraw","DrawOutline"],classic:["LastDraw","DrawOutline"],size:["PreDraw","DrawColour"],none:["LastDraw"]},i=j[aG]||j.outline;if(aG=="none"){this.Draw=function(){return 1}}else{this.drawFunc=this[i[1]]}this[i[0]]=this.Draw};x.Update=function(aM,aL,aN,aI,aJ,aK,aH,i){var j=this.tc.outlineOffset,aG=2*j;this.x=aJ*aM+aH-j;this.y=aJ*aL+i-j;this.w=aJ*aN+aG;this.h=aJ*aI+aG;this.sc=aJ;this.z=aK};x.DrawOutline=function(aJ,i,aI,j,aG,aH){aJ.strokeStyle=aH;aq(aJ,i,aI,j,aG,this.radius,true)};x.DrawColour=function(aH,aK,aI,aL,aG,i,aM,j,aJ){if(aM.oimage){aM.alpha=1;aM.Draw(aH,j,aJ,aM.oimage);return 1}return this[aM.image?"DrawColourImage":"DrawColourText"](aH,aK,aI,aL,aG,i,aM,j,aJ)};x.DrawColourText=function(aI,aL,aJ,aM,aG,i,aN,j,aK){var aH=aN.colour;aN.colour=i;aN.alpha=1;aN.Draw(aI,j,aK);aN.colour=aH;return 1};x.DrawColourImage=function(aL,aO,aM,aP,aK,i,aS,j,aN){var aQ=aL.canvas,aI=~~s(aO,0),aH=~~s(aM,0),aJ=aC(aQ.width-aI,aP)+0.5|0,aR=aC(aQ.height-aH,aK)+0.5|0,aG;if(p){p.width=aJ,p.height=aR}else{p=P(aJ,aR)}if(!p){return this.SetMethod("outline")}aG=p.getContext("2d");aG.drawImage(aQ,aI,aH,aJ,aR,0,0,aJ,aR);aL.clearRect(aI,aH,aJ,aR);aS.alpha=1;aS.Draw(aL,j,aN);aL.setTransform(1,0,0,1,0,0);aL.save();aL.beginPath();aL.rect(aI,aH,aJ,aR);aL.clip();aL.globalCompositeOperation="source-in";aL.fillStyle=i;aL.fillRect(aI,aH,aJ,aR);aL.restore();aL.globalCompositeOperation="destination-over";aL.drawImage(p,0,0,aJ,aR,aI,aH,aJ,aR);aL.globalCompositeOperation="source-over";return 1};x.DrawBlock=function(aJ,i,aI,j,aG,aH){aJ.fillStyle=aH;aq(aJ,i,aI,j,aG,this.radius)};x.DrawSimple=function(aI,i,j,aH){var aG=this.tc;aI.setTransform(1,0,0,1,0,0);aI.strokeStyle=aG.outlineColour;aI.lineWidth=aG.outlineThickness;aI.shadowBlur=aI.shadowOffsetX=aI.shadowOffsetY=0;aI.globalAlpha=1;return this.drawFunc(aI,this.x,this.y,this.w,this.h,aG.outlineColour,i,j,aH)};x.DrawPulsate=function(aJ,i,j,aH){var aI=G()-this.ts,aG=this.tc;aJ.setTransform(1,0,0,1,0,0);aJ.strokeStyle=aG.outlineColour;aJ.lineWidth=aG.outlineThickness;aJ.shadowBlur=aJ.shadowOffsetX=aJ.shadowOffsetY=0;aJ.globalAlpha=aG.pulsateTo+((1-aG.pulsateTo)*(0.5+(w(2*Math.PI*aI/(1000*aG.pulsateTime))/2)));return this.drawFunc(aJ,this.x,this.y,this.w,this.h,aG.outlineColour,i,j,aH)};x.Active=function(aG,i,j){return(i>=this.x&&j>=this.y&&i<=this.x+this.w&&j<=this.y+this.h)};x.PreDraw=x.PostDraw=x.LastDraw=az;function e(aH,aR,aN,aQ,aO,aI,aG,aK,aP,aJ,aM,j,aL,i){this.tc=aH;this.image=null;this.text=aR;this.text_original=i;this.line_widths=[];this.title=aN.title||null;this.a=aN;this.position=new ad(aQ[0],aQ[1],aQ[2]);this.x=this.y=this.z=0;this.w=aO;this.h=aI;this.colour=aG||aH.textColour;this.bgColour=aK||aH.bgColour;this.bgRadius=aP|0;this.bgOutline=aJ||this.colour;this.bgOutlineThickness=aM|0;this.textFont=j||aH.textFont;this.padding=aL|0;this.sc=this.alpha=1;this.weighted=!aH.weight}c=e.prototype;c.Init=function(j){var i=this.tc;this.outline=new J(i,this);this.textHeight=i.textHeight;if(this.HasText()){this.Measure(i.ctxt,i)}else{this.w=this.iw;this.h=this.ih}this.SetShadowColour=i.shadowAlpha?this.SetShadowColourAlpha:this.SetShadowColourFixed;this.SetDraw(i)};c.Draw=az;c.HasText=function(){return this.text&&this.text[0].length>0};c.EqualTo=function(aG){var j=aG.getElementsByTagName("img");if(this.a.href!=aG.href){return 0}if(j.length){return this.image.src==j[0].src}return(aG.innerText||aG.textContent)==this.text_original};c.SetImage=function(j){this.image=this.fimage=j};c.SetDraw=function(i){this.Draw=this.fimage?(i.ie>7?this.DrawImageIE:this.DrawImage):this.DrawText;i.noSelect&&(this.CheckActive=az)};c.MeasureText=function(aJ){var aH,aG=this.text.length,j=0,aI;for(aH=0;aH<aG;++aH){this.line_widths[aH]=aI=aJ.measureText(this.text[aH]).width;j=s(j,aI)}return j};c.Measure=function(aL,aO){var aM=t(this.text,this.textFont,this.textHeight),aP,i,aI,j,aG,aK,aN,aH,aJ;aN=aM?aM.max.y+aM.min.y:this.textHeight;aL.font=this.font=this.textHeight+"px "+this.textFont;aK=this.MeasureText(aL);if(aO.txtOpt){aP=aO.txtScale;i=aP*this.textHeight;aI=i+"px "+this.textFont;j=[aP*aO.shadowOffset[0],aP*aO.shadowOffset[1]];aL.font=aI;aG=this.MeasureText(aL);aJ=new g(this.text,aI,aG+aP,(aP*aN)+aP,aG,this.line_widths,aO.textAlign,aO.textVAlign,aP);if(this.image){aJ.SetImage(this.image,this.iw,this.ih,aO.imagePosition,aO.imagePadding,aO.imageAlign,aO.imageVAlign,aO.imageScale)}aH=aJ.Create(this.colour,this.bgColour,this.bgOutline,aP*this.bgOutlineThickness,aO.shadow,aP*aO.shadowBlur,j,aP*this.padding,aP*this.bgRadius);if(aO.outlineMethod=="colour"){this.oimage=aJ.Create(aO.outlineColour,this.bgColour,aO.outlineColour,aP*this.bgOutlineThickness,aO.shadow,aP*aO.shadowBlur,j,aP*this.padding,aP*this.bgRadius)}else{if(aO.outlineMethod=="size"){aM=t(this.text,this.textFont,this.textHeight+aO.outlineIncrease);i=aM.max.y+aM.min.y;aI=(aP*(this.textHeight+aO.outlineIncrease))+"px "+this.textFont;aL.font=aI;aG=this.MeasureText(aL);aJ=new g(this.text,aI,aG+aP,(aP*i)+aP,aG,this.line_widths,aO.textAlign,aO.textVAlign,aP);if(this.image){aJ.SetImage(this.image,this.iw+aO.outlineIncrease,this.ih+aO.outlineIncrease,aO.imagePosition,aO.imagePadding,aO.imageAlign,aO.imageVAlign,aO.imageScale)}this.oimage=aJ.Create(this.colour,this.bgColour,this.bgOutline,aP*this.bgOutlineThickness,aO.shadow,aP*aO.shadowBlur,j,aP*this.padding,aP*this.bgRadius);if(aO.outlineIncrease>0){aH=v(aH,this.oimage.width,this.oimage.height)}else{this.oimage=v(this.oimage,aH.width,aH.height)}}}if(aH){this.fimage=aH;aK=this.fimage.width/aP;aN=this.fimage.height/aP}this.SetDraw(aO);aO.txtOpt=!!this.fimage}this.h=aN;this.w=aK};c.SetFont=function(j,aH,aG,i){this.textFont=j;this.colour=aH;this.bgColour=aG;this.bgOutline=i;this.Measure(this.tc.ctxt,this.tc)};c.SetWeight=function(aG){var j=this.tc,aI=j.weightMode.split(/[, ]/),i,aH,aJ=aG.length;if(!this.HasText()){return}this.weighted=true;for(aH=0;aH<aJ;++aH){i=aI[aH]||"size";if("both"==i){this.Weight(aG[aH],j.ctxt,j,"size",j.min_weight[aH],j.max_weight[aH],aH);this.Weight(aG[aH],j.ctxt,j,"colour",j.min_weight[aH],j.max_weight[aH],aH)}else{this.Weight(aG[aH],j.ctxt,j,i,j.min_weight[aH],j.max_weight[aH],aH)}}this.Measure(j.ctxt,j)};c.Weight=function(aG,aL,aH,j,aK,aI,aJ){aG=isNaN(aG)?1:aG;var i=(aG-aK)/(aI-aK);if("colour"==j){this.colour=k(aH,i,aJ)}else{if("bgcolour"==j){this.bgColour=k(aH,i,aJ)}else{if("bgoutline"==j){this.bgOutline=k(aH,i,aJ)}else{if("size"==j){if(aH.weightSizeMin>0&&aH.weightSizeMax>aH.weightSizeMin){this.textHeight=aH.weightSize*(aH.weightSizeMin+(aH.weightSizeMax-aH.weightSizeMin)*i)}else{this.textHeight=s(1,aG*aH.weightSize)}}}}}};c.SetShadowColourFixed=function(aG,j,i){aG.shadowColor=j};c.SetShadowColourAlpha=function(aG,j,i){aG.shadowColor=U(j,i)};c.DrawText=function(aI,aL,aH){var aM=this.tc,aK=this.x,aJ=this.y,aN=this.sc,j,aG;aI.globalAlpha=this.alpha;aI.fillStyle=this.colour;aM.shadow&&this.SetShadowColour(aI,aM.shadow,this.alpha);aI.font=this.font;aK+=aL/aN;aJ+=(aH/aN)-(this.h/2);for(j=0;j<this.text.length;++j){aG=aK;if("right"==aM.textAlign){aG+=this.w/2-this.line_widths[j]}else{if("centre"==aM.textAlign){aG-=this.line_widths[j]/2}else{aG-=this.w/2}}aI.setTransform(aN,0,0,aN,aN*aG,aN*aJ);aI.fillText(this.text[j],0,0);aJ+=this.textHeight}};c.DrawImage=function(aI,aP,aH,aK){var aM=this.x,aJ=this.y,aQ=this.sc,j=aK||this.fimage,aN=this.w,aG=this.h,aL=this.alpha,aO=this.shadow;aI.globalAlpha=aL;aO&&this.SetShadowColour(aI,aO,aL);aM+=(aP/aQ)-(aN/2);aJ+=(aH/aQ)-(aG/2);aI.setTransform(aQ,0,0,aQ,aQ*aM,aQ*aJ);aI.drawImage(j,0,0,aN,aG)};c.DrawImageIE=function(aI,aM,aH){var j=this.fimage,aN=this.sc,aL=j.width=this.w*aN,aG=j.height=this.h*aN,aK=(this.x*aN)+aM-(aL/2),aJ=(this.y*aN)+aH-(aG/2);aI.setTransform(1,0,0,1,0,0);aI.globalAlpha=this.alpha;aI.drawImage(j,aK,aJ)};c.Calc=function(i,aG){var j,aJ=this.tc,aI=aJ.minBrightness,aH=aJ.maxBrightness,aK=aJ.max_radius;j=i.xform(this.position);this.xformed=j;j=V(aJ,j,aJ.stretchX,aJ.stretchY);this.x=j.x;this.y=j.y;this.z=j.z;this.sc=j.w;this.alpha=aG*au(aI+(aH-aI)*(aK-this.z)/(2*aK),0,1)};c.UpdateActive=function(aL,aG,aJ){var aI=this.outline,j=this.w,aH=this.h,i=this.x-j/2,aK=this.y-aH/2;aI.Update(i,aK,j,aH,this.sc,this.z,aG,aJ);return aI};c.CheckActive=function(aI,i,aH){var j=this.tc,aG=this.UpdateActive(aI,i,aH);return aG.Active(aI,j.mx,j.my)?aG:null};c.Clicked=function(aJ){var j=this.a,aG=j.target,aH=j.href,i;if(aG!=""&&aG!="_self"){if(self.frames[aG]){self.frames[aG].document.location=aH}else{try{if(top.frames[aG]){top.frames[aG].document.location=aH;return}}catch(aI){}window.open(aH,aG)}return}if(C.createEvent){i=C.createEvent("MouseEvents");i.initMouseEvent("click",1,1,window,0,0,0,0,0,0,0,0,0,0,null);if(!j.dispatchEvent(i)){return}}else{if(j.fireEvent){if(!j.fireEvent("onclick")){return}}}C.location=aH};function y(aM,j,aH){var aG,aJ,aL=C.getElementById(aM),aI=["id","class","innerHTML"],aK;if(!aL){throw 0}if(ah(window.G_vmlCanvasManager)){aL=window.G_vmlCanvasManager.initElement(aL);this.ie=parseFloat(navigator.appVersion.split("MSIE")[1])}if(aL&&(!aL.getContext||!aL.getContext("2d").fillText)){aJ=C.createElement("DIV");for(aG=0;aG<aI.length;++aG){aJ[aI[aG]]=aL[aI[aG]]}aL.parentNode.insertBefore(aJ,aL);aL.parentNode.removeChild(aL);throw 0}for(aG in y.options){this[aG]=aH&&ah(aH[aG])?aH[aG]:(ah(y[aG])?y[aG]:y.options[aG])}this.canvas=aL;this.ctxt=aL.getContext("2d");this.z1=250/s(this.depth,0.001);this.z2=this.z1/this.zoom;this.radius=aC(aL.height,aL.width)*0.0075;this.max_radius=100;this.max_weight=[];this.min_weight=[];this.textFont=this.textFont&&o(this.textFont);this.textHeight*=1;this.pulsateTo=au(this.pulsateTo,0,1);this.minBrightness=au(this.minBrightness,0,1);this.maxBrightness=au(this.maxBrightness,this.minBrightness,1);this.ctxt.textBaseline="top";this.lx=(this.lock+"").indexOf("x")+1;this.ly=(this.lock+"").indexOf("y")+1;this.frozen=this.dx=this.dy=this.fixedAnim=this.touchState=0;this.fixedAlpha=1;this.source=j||aM;this.repeatTags=aC(64,~~this.repeatTags);this.minTags=aC(200,~~this.minTags);if(this.minTags>0&&this.repeatTags<1&&(aG=this.GetTags().length)){this.repeatTags=ap(this.minTags/aG)-1}this.transform=R.Identity();this.startTime=this.time=G();this.mx=this.my=-1;this.centreImage&&an(this);this.Animate=this.dragControl?this.AnimateDrag:this.AnimatePosition;this.animTiming=(typeof y[this.animTiming]=="function"?y[this.animTiming]:y.Smooth);if(this.shadowBlur||this.shadowOffset[0]||this.shadowOffset[1]){this.ctxt.shadowColor=this.shadow;this.shadow=this.ctxt.shadowColor;this.shadowAlpha=ak()}else{delete this.shadow}this.Load();if(j&&this.hideTags){(function(i){if(y.loaded){i.HideTags()}else{ac("load",function(){i.HideTags()},window)}})(this)}this.yaw=this.initial?this.initial[0]*this.maxSpeed:0;this.pitch=this.initial?this.initial[1]*this.maxSpeed:0;if(this.tooltip){this.ctitle=aL.title;aL.title="";if(this.tooltip=="native"){this.Tooltip=this.TooltipNative}else{this.Tooltip=this.TooltipDiv;if(!this.ttdiv){this.ttdiv=C.createElement("div");this.ttdiv.className=this.tooltipClass;this.ttdiv.style.position="absolute";this.ttdiv.style.zIndex=aL.style.zIndex+1;ac("mouseover",function(i){i.target.style.display="none"},this.ttdiv);C.body.appendChild(this.ttdiv)}}}else{this.Tooltip=this.TooltipNone}if(!this.noMouse&&!b[aM]){b[aM]=[["mousemove",ae],["mouseout",B],["mouseup",aD],["touchstart",T],["touchend",r],["touchcancel",r],["touchmove",ay]];if(this.dragControl){b[aM].push(["mousedown",z]);b[aM].push(["selectstart",az])}if(this.wheelZoom){b[aM].push(["mousewheel",af]);b[aM].push(["DOMMouseScroll",af])}for(aG=0;aG<b[aM].length;++aG){ac(b[aM][aG][0],b[aM][aG][1],aL)}}if(!y.started){aK=window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;y.NextFrame=aK?y.NextFrameRAF:y.NextFrameTimeout;y.interval=this.interval;y.NextFrame(this.interval);y.started=1}}Q=y.prototype;Q.SourceElements=function(){if(C.querySelectorAll){return C.querySelectorAll("#"+this.source)}return[C.getElementById(this.source)]};Q.HideTags=function(){var aG=this.SourceElements(),j;for(j=0;j<aG.length;++j){aG[j].style.display="none"}};Q.GetTags=function(){var aL=this.SourceElements(),aK,aH=[],aJ,aI,aG;for(aG=0;aG<=this.repeatTags;++aG){for(aJ=0;aJ<aL.length;++aJ){aK=aL[aJ].getElementsByTagName("a");for(aI=0;aI<aK.length;++aI){aH.push(aK[aI])}}}return aH};Q.Message=function(aL){var aN=[],aH,j,aG=aL.split(""),aJ,aM,aK,aI;for(aH=0;aH<aG.length;++aH){if(aG[aH]!=" "){j=aH-aG.length/2;aJ=C.createElement("A");aJ.href="#";aJ.innerText=aG[aH];aK=100*ag(j/9);aI=-100*w(j/9);aM=new e(this,aG[aH],aJ,[aK,0,aI],2,18,"#000","#fff",0,0,0,"monospace",2,aG[aH]);aM.Init();aN.push(aM)}}return aN};Q.CreateTag=function(aK){var aN,aI,aO,aJ,aM,aG,aL,aH,j=[0,0,0];if("text"!=this.imageMode){aN=aK.getElementsByTagName("img");if(aN.length){aI=new Image;aI.src=aN[0].src;if(!this.imageMode){aO=new e(this,"",aK,j,0,0);aO.SetImage(aI);av(aI,aN[0],aO,this);return aO}}}if("image"!=this.imageMode){aM=new aA(aK);aJ=aM.Lines();if(!aM.Empty()){aG=this.textFont||o(Y(aK,"font-family"));if(this.splitWidth){aJ=aM.SplitWidth(this.splitWidth,this.ctxt,aG,this.textHeight)}aL=this.bgColour=="tag"?Y(aK,"background-color"):this.bgColour;aH=this.bgOutline=="tag"?Y(aK,"color"):this.bgOutline}else{aM=null}}if(aM||aI){aO=new e(this,aJ,aK,j,2,this.textHeight+2,this.textColour||Y(aK,"color"),aL,this.bgRadius,aH,this.bgOutlineThickness,aG,this.padding,aM&&aM.original);if(aI){aO.SetImage(aI);av(aI,aN[0],aO,this)}else{aO.Init()}return aO}};Q.UpdateTag=function(aG,i){var aJ=this.textColour||Y(i,"color"),j=this.textFont||o(Y(i,"font-family")),aI=this.bgColour=="tag"?Y(i,"background-color"):this.bgColour,aH=this.bgOutline=="tag"?Y(i,"color"):this.bgOutline;aG.a=i;aG.title=i.title;if(aG.colour!=aJ||aG.textFont!=j||aG.bgColour!=aI||aG.bgOutline!=aH){aG.SetFont(j,aJ,aI,aH)}};Q.Weight=function(aM){var aI=aM.length,aK,aG,aN,aJ=[],j,aH=this.weightFrom?this.weightFrom.split(/[, ]/):[null],aL=aH.length;for(aG=0;aG<aI;++aG){aJ[aG]=[];for(aN=0;aN<aL;++aN){aK=u(aM[aG].a,aH[aN],this.textHeight);if(!this.max_weight[aN]||aK>this.max_weight[aN]){this.max_weight[aN]=aK}if(!this.min_weight[aN]||aK<this.min_weight[aN]){this.min_weight[aN]=aK}aJ[aG][aN]=aK}}for(aN=0;aN<aL;++aN){if(this.max_weight[aN]>this.min_weight[aN]){j=1}}if(j){for(aG=0;aG<aI;++aG){aM[aG].SetWeight(aJ[aG])}}};Q.Load=function(){var aQ=this.GetTags(),aL=[],aO,aP,aK,aH,aG,j,aI,aN,aJ=[],aM={sphere:q,vcylinder:al,hcylinder:at,vring:d,hring:n};if(aQ.length){aJ.length=aQ.length;for(aN=0;aN<aQ.length;++aN){aJ[aN]=aN}this.shuffleTags&&am(aJ);aH=100*this.radiusX;aG=100*this.radiusY;j=100*this.radiusZ;this.max_radius=s(aH,s(aG,j));for(aN=0;aN<aQ.length;++aN){aP=this.CreateTag(aQ[aJ[aN]]);if(aP){aL.push(aP)}}this.weight&&this.Weight(aL,true);if(this.shapeArgs){this.shapeArgs[0]=aL.length}else{aK=this.shape.toString().split(/[(),]/);aO=aK.shift();if(typeof window[aO]==="function"){this.shape=window[aO]}else{this.shape=aM[aO]||aM.sphere}this.shapeArgs=[aL.length,aH,aG,j].concat(aK)}aI=this.shape.apply(this,this.shapeArgs);this.listLength=aL.length;for(aN=0;aN<aL.length;++aN){aL[aN].position=new ad(aI[aN][0],aI[aN][1],aI[aN][2])}}if(this.noTagsMessage&&!aL.length){aL=this.Message("No tags")}this.taglist=aL};Q.Update=function(){var aP=this.GetTags(),aO=[],aJ=this.taglist,aQ,aN=[],aL=[],aH,aM,aG,aK,aI;if(!this.shapeArgs){return this.Load()}if(aP.length){aG=this.listLength=aP.length;aM=aJ.length;for(aK=0;aK<aM;++aK){aO.push(aJ[aK]);aL.push(aK)}for(aK=0;aK<aG;++aK){for(aI=0,aQ=0;aI<aM;++aI){if(aJ[aI].EqualTo(aP[aK])){this.UpdateTag(aO[aI],aP[aK]);aQ=aL[aI]=-1}}if(!aQ){aN.push(aK)}}for(aK=0,aI=0;aK<aM;++aK){if(aL[aI]==-1){aL.splice(aI,1)}else{++aI}}if(aL.length){am(aL);while(aL.length&&aN.length){aK=aL.shift();aI=aN.shift();aO[aK]=this.CreateTag(aP[aI])}aL.sort(function(j,i){return j-i});while(aL.length){aO.splice(aL.pop(),1)}}aI=aO.length/(aN.length+1);aK=0;while(aN.length){aO.splice(ap(++aK*aI),0,this.CreateTag(aP[aN.shift()]))}this.shapeArgs[0]=aG=aO.length;aH=this.shape.apply(this,this.shapeArgs);for(aK=0;aK<aG;++aK){aO[aK].position=new ad(aH[aK][0],aH[aK][1],aH[aK][2])}this.weight&&this.Weight(aO)}this.taglist=aO};Q.SetShadow=function(i){i.shadowBlur=this.shadowBlur;i.shadowOffsetX=this.shadowOffset[0];i.shadowOffsetY=this.shadowOffset[1]};Q.Draw=function(aQ){if(this.paused){return}var aK=this.canvas,aI=aK.width,aP=aK.height,aS=0,aH=(aQ-this.time)*y.interval/1000,aO=aI/2+this.offsetX,aN=aP/2+this.offsetY,aW=this.ctxt,aM,aX,aU,aG=-1,aJ=this.taglist,aT=aJ.length,j=this.frontSelect,aR=(this.centreFunc==az),aL;this.time=aQ;if(this.frozen&&this.drawn){return this.Animate(aI,aP,aH)}aL=this.AnimateFixed();aW.setTransform(1,0,0,1,0,0);for(aU=0;aU<aT;++aU){aJ[aU].Calc(this.transform,this.fixedAlpha)}aJ=A(aJ,function(aY,i){return i.z-aY.z});if(aL&&this.fixedAnim.active){aM=this.fixedAnim.tag.UpdateActive(aW,aO,aN)}else{this.active=null;for(aU=0;aU<aT;++aU){aX=this.mx>=0&&this.my>=0&&this.taglist[aU].CheckActive(aW,aO,aN);if(aX&&aX.sc>aS&&(!j||aX.z<=0)){aM=aX;aG=aU;aM.tag=this.taglist[aU];aS=aX.sc}}this.active=aM}this.txtOpt||(this.shadow&&this.SetShadow(aW));aW.clearRect(0,0,aI,aP);for(aU=0;aU<aT;++aU){if(!aR&&aJ[aU].z<=0){try{this.centreFunc(aW,aI,aP,aO,aN)}catch(aV){alert(aV);this.centreFunc=az}aR=true}if(!(aM&&aM.tag==aJ[aU]&&aM.PreDraw(aW,aJ[aU],aO,aN))){aJ[aU].Draw(aW,aO,aN)}aM&&aM.tag==aJ[aU]&&aM.PostDraw(aW)}if(this.freezeActive&&aM){this.Freeze()}else{this.UnFreeze();this.drawn=(aT==this.listLength)}if(this.fixedCallback){this.fixedCallback(this,this.fixedCallbackTag);this.fixedCallback=null}aL||this.Animate(aI,aP,aH);aM&&aM.LastDraw(aW);aK.style.cursor=aM?this.activeCursor:"";this.Tooltip(aM,this.taglist[aG])};Q.TooltipNone=function(){};Q.TooltipNative=function(j,i){if(j){this.canvas.title=i&&i.title?i.title:""}else{this.canvas.title=this.ctitle}};Q.SetTTDiv=function(aH,j){var i=this,aG=i.ttdiv.style;if(aH!=i.ttdiv.innerHTML){aG.display="none"}i.ttdiv.innerHTML=aH;j&&(j.title=i.ttdiv.innerHTML);if(aG.display=="none"&&!i.tttimer){i.tttimer=setTimeout(function(){var aI=ab(i.canvas.id);aG.display="block";aG.left=aI.x+i.mx+"px";aG.top=aI.y+i.my+24+"px";i.tttimer=null},i.tooltipDelay)}};Q.TooltipDiv=function(j,i){if(j&&i&&i.title){this.SetTTDiv(i.title,i)}else{if(!j&&this.mx!=-1&&this.my!=-1&&this.ctitle.length){this.SetTTDiv(this.ctitle)}else{this.ttdiv.style.display="none"}}};Q.Transform=function(aJ,i,aL){if(i||aL){var j=ag(i),aK=w(i),aM=ag(aL),aI=w(aL),aG=new R([aI,0,aM,0,1,0,-aM,0,aI]),aH=new R([1,0,0,0,aK,-j,0,j,aK]);aJ.transform=aJ.transform.mul(aG.mul(aH))}};Q.AnimateFixed=function(){var aG,j,aI,i,aH;if(this.fadeIn){j=G()-this.startTime;if(j>=this.fadeIn){this.fadeIn=0;this.fixedAlpha=1}else{this.fixedAlpha=j/this.fadeIn}}if(this.fixedAnim){if(!this.fixedAnim.transform){this.fixedAnim.transform=this.transform}aG=this.fixedAnim,j=G()-aG.t0,aI=aG.angle,i,aH=this.animTiming(aG.t,j);this.transform=aG.transform;if(j>=aG.t){this.fixedCallbackTag=aG.tag;this.fixedCallback=aG.cb;this.fixedAnim=this.yaw=this.pitch=0}else{aI*=aH}i=R.Rotation(aI,aG.axis);this.transform=this.transform.mul(i);return(this.fixedAnim!=0)}return false};Q.AnimatePosition=function(aG,aJ,aH){var j=this,i=j.mx,aL=j.my,aI,aK;if(!j.frozen&&i>=0&&aL>=0&&i<aG&&aL<aJ){aI=j.maxSpeed,aK=j.reverse?-1:1;j.lx||(j.yaw=((i*2*aI/aG)-aI)*aK*aH);j.ly||(j.pitch=((aL*2*aI/aJ)-aI)*-aK*aH);j.initial=null}else{if(!j.initial){if(j.frozen&&!j.freezeDecel){j.yaw=j.pitch=0}else{j.Decel(j)}}}this.Transform(j,j.pitch,j.yaw)};Q.AnimateDrag=function(j,aI,aH){var i=this,aG=100*aH*i.maxSpeed/i.max_radius/i.zoom;if(i.dx||i.dy){i.lx||(i.yaw=i.dx*aG/i.stretchX);i.ly||(i.pitch=i.dy*-aG/i.stretchY);i.dx=i.dy=0;i.initial=null}else{if(!i.initial){i.Decel(i)}}this.Transform(i,i.pitch,i.yaw)};Q.Freeze=function(){if(!this.frozen){this.preFreeze=[this.yaw,this.pitch];this.frozen=1;this.drawn=0}};Q.UnFreeze=function(){if(this.frozen){this.yaw=this.preFreeze[0];this.pitch=this.preFreeze[1];this.frozen=0}};Q.Decel=function(i){var aG=i.minSpeed,aH=L(i.yaw),j=L(i.pitch);if(!i.lx&&aH>aG){i.yaw=aH>i.z0?i.yaw*i.decel:0}if(!i.ly&&j>aG){i.pitch=j>i.z0?i.pitch*i.decel:0}};Q.Zoom=function(i){this.z2=this.z1*(1/i);this.drawn=0};Q.Clicked=function(aG){var i=this.active;try{if(i&&i.tag){if(this.clickToFront===false||this.clickToFront===null){i.tag.Clicked(aG)}else{this.TagToFront(i.tag,this.clickToFront,function(){i.tag.Clicked(aG)},true)}}}catch(j){}};Q.Wheel=function(j){var aG=this.zoom+this.zoomStep*(j?1:-1);this.zoom=aC(this.zoomMax,s(this.zoomMin,aG));this.Zoom(this.zoom)};Q.BeginDrag=function(i){this.down=S(i,this.canvas);i.cancelBubble=true;i.returnValue=false;i.preventDefault&&i.preventDefault()};Q.Drag=function(aI,aH){if(this.dragControl&&this.down){var aG=this.dragThreshold*this.dragThreshold,j=aH.x-this.down.x,i=aH.y-this.down.y;if(this.dragging||j*j+i*i>aG){this.dx=j;this.dy=i;this.dragging=1;this.down=aH}}return this.dragging};Q.EndDrag=function(){var i=this.dragging;this.dragging=this.down=null;return i};function D(aG){var j=aG.targetTouches[0],i=aG.targetTouches[1];return F(ar(i.pageX-j.pageX,2)+ar(i.pageY-j.pageY,2))}Q.BeginPinch=function(i){this.pinched=[D(i),this.zoom];i.preventDefault&&i.preventDefault()};Q.Pinch=function(j){var aH,aG,i=this.pinched;if(!i){return}aG=D(j);aH=i[1]*aG/i[0];this.zoom=aC(this.zoomMax,s(this.zoomMin,aH));this.Zoom(this.zoom)};Q.EndPinch=function(i){this.pinched=null};Q.Pause=function(){this.paused=true};Q.Resume=function(){this.paused=false};Q.SetSpeed=function(j){this.initial=j;this.yaw=j[0]*this.maxSpeed;this.pitch=j[1]*this.maxSpeed};Q.FindTag=function(aG){if(!ah(aG)){return null}ah(aG.index)&&(aG=aG.index);if(!I(aG)){return this.taglist[aG]}var aH,aI,j;if(ah(aG.id)){aH="id",aI=aG.id}else{if(ah(aG.text)){aH="innerText",aI=aG.text}}for(j=0;j<this.taglist.length;++j){if(this.taglist[j].a[aH]==aI){return this.taglist[j]}}};Q.RotateTag=function(aO,aH,aN,i,aL,aG){var aM=aO.xformed,aJ=new ad(aM.x,aM.y,aM.z),aI=ai(aN,aH),j=aJ.angle(aI),aK=aJ.cross(aI).unit();if(j==0){this.fixedCallbackTag=aO;this.fixedCallback=aL}else{this.fixedAnim={angle:-j,axis:aK,t:i,t0:G(),cb:aL,tag:aO,active:aG}}};Q.TagToFront=function(i,aG,aH,j){this.RotateTag(i,0,0,aG,aH,j)};y.Start=function(aG,i,j){y.Delete(aG);y.tc[aG]=new y(aG,i,j)};function ax(i,j){y.tc[j]&&y.tc[j][i]()}y.Linear=function(i,j){return j/i};y.Smooth=function(i,j){return 0.5-w(j*Math.PI/i)/2};y.Pause=function(i){ax("Pause",i)};y.Resume=function(i){ax("Resume",i)};y.Reload=function(i){ax("Load",i)};y.Update=function(i){ax("Update",i)};y.SetSpeed=function(j,i){if(I(i)&&y.tc[j]&&!isNaN(i[0])&&!isNaN(i[1])){y.tc[j].SetSpeed(i);return true}return false};y.TagToFront=function(j,i){if(!I(i)){return false}i.lat=i.lng=0;return y.RotateTag(j,i)};y.RotateTag=function(aG,i){if(I(i)&&y.tc[aG]){if(isNaN(i.time)){i.time=500}var j=y.tc[aG].FindTag(i);if(j){y.tc[aG].RotateTag(j,i.lat,i.lng,i.time,i.callback,i.active);return true}}return false};y.Delete=function(aH){var j,aG;if(b[aH]){aG=C.getElementById(aH);if(aG){for(j=0;j<b[aH].length;++j){a(b[aH][j][0],b[aH][j][1],aG)}}}delete b[aH];delete y.tc[aH]};y.NextFrameRAF=function(){requestAnimationFrame(E)};y.NextFrameTimeout=function(i){setTimeout(O,i)};y.tc={};y.options={z1:20000,z2:20000,z0:0.0002,freezeActive:false,freezeDecel:false,activeCursor:"pointer",pulsateTo:1,pulsateTime:3,reverse:false,depth:0.5,maxSpeed:0.05,minSpeed:0,decel:0.95,interval:20,minBrightness:0.1,maxBrightness:1,outlineColour:"#ffff99",outlineThickness:2,outlineOffset:5,outlineMethod:"outline",outlineRadius:0,textColour:"#ff99ff",textHeight:15,textFont:"Helvetica, Arial, sans-serif",shadow:"#000",shadowBlur:0,shadowOffset:[0,0],initial:null,hideTags:true,zoom:1,weight:false,weightMode:"size",weightFrom:null,weightSize:1,weightSizeMin:null,weightSizeMax:null,weightGradient:{0:"#f00",0.33:"#ff0",0.66:"#0f0",1:"#00f"},txtOpt:true,txtScale:2,frontSelect:false,wheelZoom:true,zoomMin:0.3,zoomMax:3,zoomStep:0.05,shape:"sphere",lock:null,tooltip:null,tooltipDelay:300,tooltipClass:"tctooltip",radiusX:1,radiusY:1,radiusZ:1,stretchX:1,stretchY:1,offsetX:0,offsetY:0,shuffleTags:false,noSelect:false,noMouse:false,imageScale:1,paused:false,dragControl:false,dragThreshold:4,centreFunc:az,splitWidth:0,animTiming:"Smooth",clickToFront:false,fadeIn:0,padding:0,bgColour:null,bgRadius:0,bgOutline:null,bgOutlineThickness:0,outlineIncrease:4,textAlign:"centre",textVAlign:"middle",imageMode:null,imagePosition:null,imagePadding:2,imageAlign:"centre",imageVAlign:"middle",noTagsMessage:true,centreImage:null,pinchZoom:false,repeatTags:0,minTags:0};for(M in y.options){y[M]=y.options[M]}window.TagCanvas=y;jQuery.fn.tagcanvas=function(j,i){var aG={pause:function(){ao(this).each(function(){ax("Pause",ao(this)[0].id)})},resume:function(){ao(this).each(function(){ax("Resume",ao(this)[0].id)})},reload:function(){ao(this).each(function(){ax("Load",ao(this)[0].id)})},update:function(){ao(this).each(function(){ax("Update",ao(this)[0].id)})},tagtofront:function(){ao(this).each(function(){y.TagToFront(ao(this)[0].id,i)})},rotatetag:function(){ao(this).each(function(){y.RotateTag(ao(this)[0].id,i)})},"delete":function(){ao(this).each(function(){y.Delete(ao(this)[0].id)})},setspeed:function(){ao(this).each(function(){y.SetSpeed(ao(this)[0].id,i)})}};if(typeof j=="string"&&aG[j]){aG[j].apply(this);return this}else{y.jquery=1;ao(this).each(function(){y.Start(ao(this)[0].id,i,j)});return y.started}};ac("load",function(){y.loaded=1},window)})(jQuery);
